#!/usr/bin/env bash

set -e

# Check if inside a Git repository
if ! git rev-parse --is-inside-work-tree &>/dev/null; then
    echo "Not inside a Git repository. Aborting." >&2
    exit 1
fi

# Auto-detect whether to use main/master
if git show-ref --verify --quiet refs/heads/main; then
    default_branch="main"
elif git show-ref --verify --quiet refs/heads/master; then
    default_branch="master"
else
    echo "Default branch 'main' or 'master' not found. Aborting." >&2
    exit 1
fi

# List merged branches except the current branch
git branch --merged "$default_branch" | grep -vE '^\*|\s*'"$default_branch"'$' | sed 's/^[ *]*//' || {
    echo "No branches found to clean."
    exit 0
}

echo "Use 'git-clean-branches | xargs git branch -d' to actually delete these." >&2
